<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MSG Buyer - Seller Details</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: #f5f5f5;
            min-height: 100vh;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 16px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 { font-size: 20px; }

        .nav-links {
            display: flex;
            gap: 16px;
        }

        .nav-links a {
            color: white;
            text-decoration: none;
            padding: 8px 16px;
            border-radius: 6px;
            background: rgba(255,255,255,0.1);
        }

        .nav-links a:hover { background: rgba(255,255,255,0.25); }

        .back-btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            color: white;
            text-decoration: none;
            padding: 8px 16px;
            border-radius: 6px;
            background: rgba(255,255,255,0.1);
        }

        .back-btn:hover { background: rgba(255,255,255,0.25); }

        /* Split layout */
        .main-container {
            display: flex;
            height: calc(100vh - 60px);
            overflow: hidden;
        }

        .left-panel {
            flex: 1;
            overflow-y: auto;
            padding: 24px;
            min-width: 50%;
        }

        .resize-handle {
            width: 6px;
            background: #e0e0e0;
            cursor: col-resize;
            transition: background 0.2s;
            flex-shrink: 0;
        }

        .resize-handle:hover,
        .resize-handle.dragging {
            background: #667eea;
        }

        .right-panel {
            width: 30%;
            min-width: 20%;
            max-width: 50%;
            background: white;
            display: flex;
            flex-direction: column;
        }

        /* Seller card */
        .seller-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 16px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .seller-info h2 { font-size: 20px; margin-bottom: 4px; }
        .seller-info p { color: #666; font-size: 13px; margin-bottom: 2px; }

        .seller-stats { display: flex; gap: 20px; }
        .stat { text-align: center; }
        .stat .value { font-size: 24px; font-weight: 600; }
        .stat .label { font-size: 11px; color: #666; text-transform: uppercase; }
        .stat .value.green { color: #28a745; }
        .stat .value.red { color: #dc3545; }

        /* Filters */
        .filters {
            background: white;
            padding: 16px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            margin-bottom: 16px;
            display: flex;
            gap: 16px;
            flex-wrap: wrap;
            align-items: center;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .filter-group label {
            font-size: 12px;
            color: #666;
            font-weight: 600;
            text-transform: uppercase;
        }

        .filter-group select, .filter-group input {
            padding: 10px 16px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            min-width: 150px;
        }

        .filter-group select:focus, .filter-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        /* Table */
        .table-container {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            overflow: hidden;
        }

        .table-scroll {
            max-height: calc(100vh - 320px);
            overflow-y: auto;
        }

        table { width: 100%; border-collapse: collapse; }

        th {
            background: #f8f9fa;
            padding: 10px 12px;
            text-align: left;
            font-size: 11px;
            text-transform: uppercase;
            color: #666;
            font-weight: 600;
            position: sticky;
            top: 0;
        }

        td {
            padding: 10px 12px;
            border-bottom: 1px solid #eee;
            font-size: 13px;
        }

        tr.product-row { cursor: pointer; }
        tr.product-row:hover { background: #f8f9fa; }
        tr.product-row.selected { background: #e8f4fd; }

        tr.matches-row {
            background: #f8f9fa;
            display: none;
        }
        tr.matches-row.expanded { display: table-row; }

        .matches-container {
            padding: 12px;
            background: white;
            border-radius: 6px;
            margin: 4px 0;
        }

        .match-item {
            padding: 8px;
            margin: 4px 0;
            background: #fff;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-size: 12px;
        }

        .match-item:hover { background: #fafafa; }

        .expand-icon {
            transition: transform 0.2s;
            display: inline-block;
            font-size: 12px;
            margin-right: 4px;
        }

        tr.product-row.expanded .expand-icon { transform: rotate(90deg); }

        .product-image {
            width: 40px;
            height: 40px;
            object-fit: cover;
            border-radius: 4px;
            background: #eee;
        }

        .badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 10px;
            font-size: 11px;
            font-weight: 600;
        }

        .badge-ok { background: #d4edda; color: #155724; }
        .badge-high { background: #f8d7da; color: #721c24; }
        .badge-eur { background: #cce5ff; color: #004085; }
        .badge-gur { background: #fff3cd; color: #856404; }

        .price { font-weight: 600; font-size: 12px; }
        .price.ok { color: #28a745; }
        .price.high { color: #dc3545; }

        .code {
            font-family: monospace;
            background: #f0f0f0;
            padding: 2px 5px;
            border-radius: 3px;
            font-size: 11px;
        }

        .link { color: #667eea; text-decoration: none; font-size: 12px; }
        .link:hover { text-decoration: underline; }

        .loading { text-align: center; padding: 40px; color: #666; }

        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 16px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .empty-state { text-align: center; padding: 40px; color: #666; }
        .matched-info { font-size: 10px; color: #888; }

        .checkbox-cell { width: 30px; text-align: center; }
        .checkbox-cell input { width: 16px; height: 16px; cursor: pointer; }

        /* Chat panel */
        .chat-header {
            padding: 16px;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chat-header h3 { font-size: 16px; color: #333; }

        .lang-switcher {
            display: flex;
            gap: 4px;
        }

        .lang-btn {
            padding: 4px 10px;
            border: 1px solid #ddd;
            background: white;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }

        .lang-btn.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .chat-body {
            flex: 1;
            padding: 16px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        .selected-count {
            background: #f0f0f0;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 12px;
            font-size: 13px;
            color: #666;
        }

        .selected-count strong { color: #333; }

        .subject-input {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 13px;
            margin-bottom: 12px;
        }

        .subject-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .message-textarea {
            flex: 1;
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 13px;
            line-height: 1.5;
            resize: none;
            min-height: 200px;
        }

        .message-textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .chat-footer {
            padding: 16px;
            border-top: 1px solid #e0e0e0;
        }

        .send-btn {
            width: 100%;
            padding: 12px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: background 0.2s;
        }

        .send-btn:hover { background: #5a6fd6; }
        .send-btn:disabled { background: #ccc; cursor: not-allowed; }

        /* Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal-overlay.active { display: flex; }

        .modal {
            background: white;
            border-radius: 12px;
            padding: 24px;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
        }

        .modal h4 {
            font-size: 18px;
            margin-bottom: 12px;
            color: #333;
        }

        .modal p {
            color: #666;
            font-size: 14px;
            margin-bottom: 20px;
            line-height: 1.5;
        }

        .modal-buttons {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }

        .modal-btn {
            padding: 10px 20px;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            border: none;
        }

        .modal-btn.cancel {
            background: #f0f0f0;
            color: #333;
        }

        .modal-btn.cancel:hover { background: #e0e0e0; }

        .modal-btn.confirm {
            background: #667eea;
            color: white;
        }

        .modal-btn.confirm:hover { background: #5a6fd6; }
    </style>
</head>
<body>
    <header class="header">
        <h1>MSG Buyer</h1>
        <nav class="nav-links">
            <a href="/razom-catalog">Catalog Matches</a>
            <a href="/sellers">Sellers</a>
            <a href="/conversations">Conversations</a>
        </nav>
        <a href="/sellers" class="back-btn">← Back</a>
    </header>

    <div class="main-container">
        <!-- Left Panel: Positions List -->
        <div class="left-panel">
            <div class="seller-card">
                <div class="seller-info">
                    <h2 id="seller-name">Loading...</h2>
                    <p id="seller-email"></p>
                    <p id="seller-phone"></p>
                </div>
                <div class="seller-stats">
                    <div class="stat">
                        <div class="value green" id="ok-count">-</div>
                        <div class="label">OK</div>
                    </div>
                    <div class="stat">
                        <div class="value red" id="high-count">-</div>
                        <div class="label">HIGH</div>
                    </div>
                    <div class="stat">
                        <div class="value" id="total-count">-</div>
                        <div class="label">Total</div>
                    </div>
                </div>
            </div>

            <div class="filters">
                <div class="filter-group">
                    <label>Catalog</label>
                    <select id="catalog-filter" onchange="applyFilters()">
                        <option value="">All</option>
                        <option value="eur,gur" selected>EUR + GUR</option>
                        <option value="eur">EUR</option>
                        <option value="gur">GUR</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Segment</label>
                    <select id="segment-filter" onchange="applyFilters()">
                        <option value="">All</option>
                        <option value="TOP">TOP</option>
                        <option value="STANDARD">STANDARD</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Price Classification</label>
                    <select id="price-filter" onchange="applyFilters()">
                        <option value="">All</option>
                        <option value="OK">OK</option>
                        <option value="HIGH">HIGH</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Search OES</label>
                    <input type="text" id="search-input" placeholder="Search OES numbers..." oninput="applyFilters()">
                </div>
            </div>

            <div class="table-container">
                <div class="table-scroll">
                    <table>
                        <thead>
                            <tr>
                                <th class="checkbox-cell"><input type="checkbox" onclick="toggleSelectAll(this)"></th>
                                <th>Seller Product Code</th>
                                <th>Matches</th>
                                <th>Price €</th>
                                <th>Best Match</th>
                                <th>Link</th>
                            </tr>
                        </thead>
                        <tbody id="positions-table">
                            <tr>
                                <td colspan="7">
                                    <div class="loading">
                                        <div class="spinner"></div>
                                        Loading...
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Resize Handle -->
        <div class="resize-handle" id="resize-handle"></div>

        <!-- Right Panel: Chat -->
        <div class="right-panel" id="right-panel">
            <div class="chat-header">
                <h3>Compose Email</h3>
                <div class="lang-switcher">
                    <button class="lang-btn" onclick="setLanguage('ru')">RU</button>
                    <button class="lang-btn" onclick="setLanguage('ua')">UA</button>
                    <button class="lang-btn active" onclick="setLanguage('en')">EN</button>
                </div>
            </div>
            <div class="chat-body">
                <div class="selected-count">
                    Selected: <strong id="selected-count">0</strong> positions
                </div>
                <input type="text" class="subject-input" id="email-subject" placeholder="Subject...">
                <textarea class="message-textarea" id="email-body" placeholder="Select positions to generate email template..."></textarea>
            </div>
            <div class="chat-footer">
                <button class="send-btn" id="send-btn" onclick="showSendConfirmation()">Send</button>
            </div>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div class="modal-overlay" id="send-modal">
        <div class="modal">
            <h4>Send Email?</h4>
            <p>Are you sure you want to send this email to <strong id="modal-recipient"></strong>?</p>
            <div class="modal-buttons">
                <button class="modal-btn cancel" onclick="closeModal()">Cancel</button>
                <button class="modal-btn confirm" onclick="confirmSend()">Send</button>
            </div>
        </div>
    </div>

    <script>
        const token = localStorage.getItem('auth_token');
        if (!token) window.location.href = '/login';

        const pathParts = window.location.pathname.split('/');
        const sellerEmail = decodeURIComponent(pathParts[pathParts.length - 1]);

        let allPositions = [];
        let filteredPositions = [];
        let groupedProducts = {}; // Group positions by part_id
        let selectedPositions = new Set();
        let expandedRows = new Set();
        let currentFilter = 'all';
        let currentLanguage = 'en';

        // Email templates
        const templates = {
            ru: {
                subject: "Запрос на сотрудничество закупка рулевых реек (Master Service)",
                header: "Здравствуйте!\n\nМеня зовут Василий, я представляю компанию Master Service (Украина). Мы специализируемся на продаже и восстановлении рулевых реек и насосов ГУР.\n\nВ настоящее время мы ищем новых партнеров в Польше для регулярных закупок б/у рулевых реек (оригинал, без повреждений корпуса и креплений).\n\nПланируемые объемы закупок — от 500 до 1000 штук за партию, с возможностью постоянного сотрудничества при успешном первом заказе.\n\n",
                partsHeader: "Нас интересуют следующие позиции:\n",
                footer: "\n\nБудем благодарны, если вы сможете сообщить:\n• Наличие ассортимента на складе\n• Частоту пополнения склада\n\nТакже будем рады, если вы сможете прислать фото типовых партий или краткое описание ассортимента.\n\nМы открыты к диалогу и готовы обсудить детали тестовой закупки.\n\nС уважением,\nВасилий\nMaster Service (Украина)"
            },
            ua: {
                subject: "Запит на співпрацю закупівля рульових рейок (Master Service)",
                header: "Вітаю!\n\nМене звати Василь, я представляю компанію Master Service (Україна). Ми спеціалізуємося на продажу та відновленні рульових рейок та насосів ГПК.\n\nНаразі ми шукаємо нових партнерів у Польщі для регулярних закупівель б/в рульових рейок (оригінал, без пошкоджень корпусу та кріплень).\n\nПлановані обсяги закупівель — від 500 до 1000 штук за партію, з можливістю постійної співпраці після успішного першого замовлення.\n\n",
                partsHeader: "Нас цікавлять наступні позиції:\n",
                footer: "\n\nБудемо вдячні, якщо ви зможете повідомити:\n• Наявність асортименту на складі\n• Частоту поповнення складу\n\nТакож будемо раді, якщо ви зможете надіслати фото типових партій або короткий опис асортименту.\n\nМи відкриті до діалогу та готові обговорити деталі тестової закупівлі.\n\nЗ повагою,\nВасиль\nMaster Service (Україна)"
            },
            en: {
                subject: "Partnership Inquiry Steering Rack Procurement (Master Service)",
                header: "Hello!\n\nMy name is Vasyl, and I represent Master Service (Ukraine). We specialize in the sale and remanufacturing of steering racks and power steering pumps.\n\nWe are currently looking for new partners in Poland for regular purchases of used steering racks (original parts, without damage to the housing or mounts).\n\nOur planned purchase volumes are 500 to 1,000 units per batch, with the possibility of ongoing cooperation following a successful first order.\n\n",
                partsHeader: "We are interested in the following items:\n",
                footer: "\n\nWe would appreciate it if you could provide information on:\n• Current stock availability\n• Stock replenishment frequency\n\nWe would also be grateful if you could send photos of typical batches or a brief description of your product range.\n\nWe are open to discussion and ready to negotiate the details of a trial purchase.\n\nBest regards,\nVasyl\nMaster Service (Ukraine)"
            }
        };

        async function loadSeller() {
            try {
                const res = await fetch(`/api/seller/${encodeURIComponent(sellerEmail)}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (res.status === 401) {
                    localStorage.removeItem('auth_token');
                    window.location.href = '/login';
                    return;
                }
                if (!res.ok) throw new Error('Not found');
                const seller = await res.json();

                document.getElementById('seller-name').textContent = seller.name || seller.title || 'Unknown';
                document.getElementById('seller-email').textContent = seller.email || '';
                document.getElementById('seller-phone').textContent = seller.phone ? `Phone: ${seller.phone}` : '';
                document.title = `${seller.name || seller.email} - MSG Buyer`;
            } catch (e) {
                document.getElementById('seller-name').textContent = sellerEmail;
            }
        }

        async function loadPositions() {
            try {
                const res = await fetch(`/api/seller/${encodeURIComponent(sellerEmail)}/positions`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (res.status === 401) {
                    localStorage.removeItem('auth_token');
                    window.location.href = '/login';
                    return;
                }
                if (!res.ok) throw new Error('Failed to load');
                allPositions = await res.json();

                // Group positions by part_id
                groupedProducts = {};
                allPositions.forEach(pos => {
                    if (!groupedProducts[pos.part_id]) {
                        groupedProducts[pos.part_id] = {
                            part_id: pos.part_id,
                            code: pos.code,
                            price: pos.price,
                            url: pos.url,
                            matches: []
                        };
                    }
                    groupedProducts[pos.part_id].matches.push(pos);
                });

                filteredPositions = allPositions;
                updateStats();
                renderTable();
            } catch (e) {
                document.getElementById('positions-table').innerHTML = `
                    <tr><td colspan="7"><div class="empty-state">Failed to load</div></td></tr>
                `;
            }
        }

        function updateStats() {
            const ok = allPositions.filter(p => p.classification === 'OK').length;
            const high = allPositions.filter(p => p.classification === 'HIGH').length;
            document.getElementById('ok-count').textContent = ok;
            document.getElementById('high-count').textContent = high;
            document.getElementById('total-count').textContent = allPositions.length;
        }

        function renderTable() {
            // Get filtered product IDs
            const filteredPartIds = new Set(filteredPositions.map(p => p.part_id));
            const productsToShow = Object.values(groupedProducts).filter(prod => filteredPartIds.has(prod.part_id));

            if (productsToShow.length === 0) {
                document.getElementById('positions-table').innerHTML = `
                    <tr><td colspan="6"><div class="empty-state">No positions found</div></td></tr>
                `;
                return;
            }

            let html = '';
            productsToShow.forEach(product => {
                const isSelected = selectedPositions.has(product.part_id);
                const isExpanded = expandedRows.has(product.part_id);

                // Find best match (OK first, then lowest price)
                const okMatches = product.matches.filter(m => m.classification === 'OK');
                const bestMatch = okMatches.length > 0
                    ? okMatches.reduce((best, m) => !best || m.catalog_price_eur < best.catalog_price_eur ? m : best, null)
                    : product.matches.reduce((best, m) => !best || (m.catalog_price_eur && m.catalog_price_eur < best.catalog_price_eur) ? m : best, product.matches[0]);

                // Product row
                html += `
                <tr class="product-row ${isSelected ? 'selected' : ''} ${isExpanded ? 'expanded' : ''}" onclick="toggleProductRow('${product.part_id}')">
                    <td class="checkbox-cell">
                        <input type="checkbox" ${isSelected ? 'checked' : ''} onclick="event.stopPropagation(); togglePosition('${product.part_id}')">
                    </td>
                    <td>
                        <span class="expand-icon">▶</span>
                        <span class="code">${product.code || product.part_id}</span>
                    </td>
                    <td>${product.matches.length} catalog item(s)</td>
                    <td class="price">${product.price ? '€' + product.price.toFixed(2) : '-'}</td>
                    <td>
                        ${bestMatch ? `<span class="badge badge-${bestMatch.classification?.toLowerCase() || 'na'}">${bestMatch.classification || 'N/A'}</span>` : '-'}
                        ${bestMatch && bestMatch.catalog_price_eur ? ` €${bestMatch.catalog_price_eur.toFixed(2)}` : ''}
                    </td>
                    <td>${product.url ? `<a href="${product.url}" target="_blank" class="link" onclick="event.stopPropagation()">View</a>` : '-'}</td>
                </tr>`;

                // Matches row (expandable)
                html += `
                <tr class="matches-row ${isExpanded ? 'expanded' : ''}">
                    <td colspan="6">
                        <div class="matches-container">
                            ${product.matches.map(match => `
                                <div class="match-item">
                                    <div>
                                        <strong>${match.catalog_data.article || 'N/A'}</strong>
                                        <span class="code">${match.catalog}</span>
                                        ${match.matched_by ? `<span class="matched-info"> • Matched: ${match.matched_value} (${match.matched_by})</span>` : ''}
                                    </div>
                                    <div>
                                        <span class="badge badge-${match.classification?.toLowerCase() || 'na'}">${match.classification || 'N/A'}</span>
                                        ${match.catalog_price_eur ? ` €${match.catalog_price_eur.toFixed(2)}` : ''}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </td>
                </tr>`;
            });

            document.getElementById('positions-table').innerHTML = html;
        }

        function toggleProductRow(partId) {
            if (expandedRows.has(partId)) {
                expandedRows.delete(partId);
            } else {
                expandedRows.add(partId);
            }
            renderTable();
        }

        function togglePosition(id) {
            if (selectedPositions.has(id)) {
                selectedPositions.delete(id);
            } else {
                selectedPositions.add(id);
            }
            renderTable();
            updateEmailTemplate();
        }

        function toggleSelectAll(checkbox) {
            const filteredPartIds = new Set(filteredPositions.map(p => p.part_id));
            const productsToToggle = Object.values(groupedProducts).filter(prod => filteredPartIds.has(prod.part_id));

            if (checkbox.checked) {
                productsToToggle.forEach(p => selectedPositions.add(p.part_id));
            } else {
                productsToToggle.forEach(p => selectedPositions.delete(p.part_id));
            }
            renderTable();
            updateEmailTemplate();
        }

        function applyFilters() {
            const catalog = document.getElementById('catalog-filter').value;
            const segment = document.getElementById('segment-filter').value;
            const priceClass = document.getElementById('price-filter').value;
            const search = document.getElementById('search-input').value.toLowerCase();

            filteredPositions = allPositions.filter(p => {
                // Catalog filter
                if (catalog) {
                    const catalogs = catalog.split(',');
                    if (!catalogs.includes(p.catalog)) return false;
                }

                // Segment filter
                if (segment && p.catalog_segments !== segment) return false;

                // Price classification filter
                if (priceClass && p.classification !== priceClass) return false;

                // OES search filter
                if (search && p.catalog_oes_numbers && !p.catalog_oes_numbers.toLowerCase().includes(search)) return false;

                return true;
            });

            renderTable();
        }

        function setLanguage(lang) {
            currentLanguage = lang;
            document.querySelectorAll('.lang-btn').forEach(btn => {
                btn.classList.toggle('active', btn.textContent.toLowerCase() === lang);
            });
            updateEmailTemplate();
        }

        function updateEmailTemplate() {
            const count = selectedPositions.size;
            document.getElementById('selected-count').textContent = count;

            const template = templates[currentLanguage];
            document.getElementById('email-subject').value = template.subject;

            if (count === 0) {
                document.getElementById('email-body').value = '';
                return;
            }

            // Get selected products
            const selectedProducts = Object.values(groupedProducts).filter(p => selectedPositions.has(p.part_id));

            // Format parts list
            let partsList = template.partsHeader;
            selectedProducts.forEach(p => {
                let line = '• ';
                if (p.code) line += `SKU: ${p.code}`;
                if (p.url) line += ` | ${p.url}`;
                partsList += line + '\n';
            });

            document.getElementById('email-body').value = template.header + partsList + template.footer;
        }

        function showSendConfirmation() {
            if (selectedPositions.size === 0) {
                alert('Please select at least one position');
                return;
            }
            document.getElementById('modal-recipient').textContent = sellerEmail;
            document.getElementById('send-modal').classList.add('active');
        }

        function closeModal() {
            document.getElementById('send-modal').classList.remove('active');
        }

        async function confirmSend() {
            const subject = document.getElementById('email-subject').value;
            const body = document.getElementById('email-body').value;
            const selectedPartIds = Array.from(selectedPositions);

            // Disable button and show loading
            const confirmBtn = document.querySelector('.modal-btn.confirm');
            const originalText = confirmBtn.textContent;
            confirmBtn.textContent = 'Sending...';
            confirmBtn.disabled = true;

            try {
                const res = await fetch('/api/conversations', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        seller_email: sellerEmail,
                        position_ids: selectedPartIds,
                        subject: subject,
                        body: body,
                        language: currentLanguage
                    })
                });

                if (res.status === 401) {
                    localStorage.removeItem('auth_token');
                    window.location.href = '/login';
                    return;
                }

                const data = await res.json();

                if (res.ok && data.success) {
                    closeModal();
                    // Clear selection and show success
                    selectedPositions.clear();
                    renderTable();
                    updateEmailTemplate();
                    alert('Email sent successfully! Conversation ID: ' + data.conversation_id);
                } else {
                    alert('Failed to send email: ' + (data.detail || data.error || 'Unknown error'));
                }
            } catch (e) {
                alert('Error sending email: ' + e.message);
            } finally {
                confirmBtn.textContent = originalText;
                confirmBtn.disabled = false;
            }
        }

        // Close modal on overlay click
        document.getElementById('send-modal').addEventListener('click', function(e) {
            if (e.target === this) closeModal();
        });

        // Resize handle functionality
        const resizeHandle = document.getElementById('resize-handle');
        const rightPanel = document.getElementById('right-panel');
        const mainContainer = document.querySelector('.main-container');
        let isResizing = false;

        resizeHandle.addEventListener('mousedown', (e) => {
            isResizing = true;
            resizeHandle.classList.add('dragging');
            document.body.style.cursor = 'col-resize';
            document.body.style.userSelect = 'none';
        });

        document.addEventListener('mousemove', (e) => {
            if (!isResizing) return;

            const containerRect = mainContainer.getBoundingClientRect();
            const containerWidth = containerRect.width;
            const mouseX = e.clientX - containerRect.left;

            // Calculate right panel width (from right edge)
            let newWidth = containerWidth - mouseX;

            // Constrain to 20%-50% of container width
            const minWidth = containerWidth * 0.2;
            const maxWidth = containerWidth * 0.5;
            newWidth = Math.max(minWidth, Math.min(maxWidth, newWidth));

            rightPanel.style.width = newWidth + 'px';
        });

        document.addEventListener('mouseup', () => {
            if (isResizing) {
                isResizing = false;
                resizeHandle.classList.remove('dragging');
                document.body.style.cursor = '';
                document.body.style.userSelect = '';
            }
        });

        loadSeller();
        loadPositions();
    </script>
</body>
</html>
